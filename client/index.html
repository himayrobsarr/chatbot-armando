<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Avatar Live</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 50px; }
    #avatar { width: 640px; height: 480px; background: #000; margin: 20px auto; }
    button { padding: 15px 30px; font-size: 18px; margin: 10px; }
  </style>
</head>
<body>
  <h1>🎙️ Avatar con Lip-Sync en Vivo</h1>
  <video id="avatar" autoplay playsinline></video>
  <div>
    <button id="startBtn">Iniciar Avatar</button>
    <button id="speakBtn" disabled>🎤 Hablar</button>
  </div>

  <script>
    const ws = new WebSocket('ws://localhost:3000');
    const video = document.getElementById('avatar');
    const startBtn = document.getElementById('startBtn');
    const speakBtn = document.getElementById('speakBtn');
    
    let mediaRecorder;
    let heygenPeerConnection;

    // 1. Iniciar sesión HeyGen
    startBtn.onclick = async () => {
      const res = await fetch('http://localhost:3000/api/test/heygen/session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ avatarId: 'default' })
      });
      const session = await res.json();
      
      // WebRTC con HeyGen
      heygenPeerConnection = new RTCPeerConnection();
      heygenPeerConnection.ontrack = (event) => {
        video.srcObject = event.streams[0];
      };

      // Implementación básica de WebRTC para HeyGen
      // Nota: Esta es una implementación simplificada
      // Para producción, seguir la documentación completa de HeyGen
      try {
        const offer = await heygenPeerConnection.createOffer();
        await heygenPeerConnection.setLocalDescription(offer);
        
        // Aquí se enviaría el offer a HeyGen y se recibiría el answer
        // Por ahora, solo mostramos que la conexión está lista
        console.log('WebRTC offer creado:', offer);
      } catch (error) {
        console.error('Error creando WebRTC offer:', error);
      }
      
      speakBtn.disabled = false;
      startBtn.disabled = true;
    };

    // 2. Capturar audio del usuario
    speakBtn.onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      
      mediaRecorder.ondataavailable = (e) => {
        // Enviar chunk al servidor
        ws.send(e.data);
      };

      mediaRecorder.start(250); // Chunks cada 250ms
      speakBtn.textContent = '🔴 Grabando...';
      
      setTimeout(() => {
        mediaRecorder.stop();
        speakBtn.textContent = '🎤 Hablar';
      }, 5000); // 5 segs de prueba
    };

    ws.onmessage = (msg) => {
      const data = JSON.parse(msg.data);
      console.log('Respuesta:', data);
    };
  </script>
</body>
</html>