<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üé§ Chatbot de Voz Inteligente</title>
  <script src="js/livekit-loader.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #0f172a;
      color: #fff;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .container {
      background: #1e293b;
      border-radius: 24px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      padding: 48px;
      max-width: 720px;
      width: 100%;
      border: 1px solid #334155;
    }
    h1 {
      text-align: center;
      margin-bottom: 8px;
      font-size: 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .subtitle {
      text-align: center;
      color: #94a3b8;
      margin-bottom: 40px;
      font-size: 16px;
    }
    .mic-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      margin: 40px 0;
    }
    .mic-button {
      width: 140px; height: 140px;
      border-radius: 50%;
      border: 4px solid #667eea;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 56px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
      display: flex; align-items: center; justify-content: center;
      user-select: none;
    }
    .mic-button:hover { transform: scale(1.05); box-shadow: 0 15px 50px rgba(102, 126, 234, 0.6); }
    .mic-button.recording {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      border-color: #ef4444;
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); box-shadow: 0 10px 40px rgba(239, 68, 68, 0.4); }
      50% { transform: scale(1.08); box-shadow: 0 15px 60px rgba(239, 68, 68, 0.8); }
    }
    .status {
      text-align: center;
      padding: 16px 24px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 18px;
      min-width: 300px;
      transition: all 0.3s ease;
    }
    .status.idle { background: #1e40af20; color: #60a5fa; border: 2px solid #1e40af40; }
    .status.listening { background: #f59e0b20; color: #fbbf24; border: 2px solid #f59e0b40; }
    .status.processing { background: #8b5cf620; color: #a78bfa; border: 2px solid #8b5cf640; }
    .status.playing { background: #10b98120; color: #34d399; border: 2px solid #10b98140; }

    .transcript-box, .response-box {
      background: #0f172a;
      border-radius: 16px;
      padding: 24px;
      margin-top: 32px;
      border: 1px solid #334155;
      min-height: 100px;
    }
    .transcript-box h3, .response-box h3 {
      color: #94a3b8;
      margin-bottom: 12px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }
    .transcript-text, .response-text {
      color: #e2e8f0;
      font-size: 18px;
      line-height: 1.6;
      font-style: italic;
    }
    .response-text {
      font-style: normal;
      color: #a5b4fc;
    }

    .avatar-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      margin-top: 32px;
      padding: 24px;
      background: #0f172a;
      border-radius: 16px;
      border: 1px solid #334155;
    }

    .avatar-container h3 {
      color: #94a3b8;
      margin-bottom: 8px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }

    .controls {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 24px;
    }
    .btn {
      padding: 12px 24px;
      border: 2px solid #334155;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      background: #1e293b;
      color: #e2e8f0;
      font-size: 15px;
    }
    .btn:hover { background: #334155; border-color: #475569; transform: translateY(-2px); }
    .error-msg {
      background: #7f1d1d;
      color: #fca5a5;
      padding: 16px 20px;
      border-radius: 12px;
      margin-top: 20px;
      text-align: center;
      border: 2px solid #991b1b;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ü§ñ Chatbot de Voz</h1>
    <p class="subtitle">Habla y escucha respuestas generadas por IA</p>

    <div class="mic-container">
      <button id="micBtn" class="mic-button" type="button">üé§</button>
      <div id="status" class="status idle">Presiona el micr√≥fono para comenzar</div>
    </div>

    <div class="transcript-box">
      <h3>üó£Ô∏è Tu voz (Transcripci√≥n)</h3>
      <div id="transcript" class="transcript-text empty">Aqu√≠ aparecer√° lo que digas...</div>
    </div>

    <div class="response-box">
      <h3>üí¨ Respuesta del Chatbot</h3>
      <div id="response" class="response-text">Esperando tu mensaje...</div>
    </div>

    <div class="avatar-container">
      <h3>ü§ñ Avatar Interactivo</h3>
      <video id="avatarVideo" autoplay muted playsinline style="width: 100%; max-width: 400px; border-radius: 16px; background: #0f172a;"></video>
      <div id="avatarStatus" class="status idle" style="margin-top: 16px;">
        Avatar desconectado
      </div>
    </div>

    <div class="controls">
      <button id="clearBtn" class="btn">üóëÔ∏è Limpiar</button>
      <button id="loadAvatarBtn" class="btn">ü§ñ Cargar Avatar</button>
      <button id="testBtn" class="btn">üß™ Test Chatbot</button>
      <button id="disconnectAvatarBtn" class="btn">ü§ñ Desconectar Avatar</button>
    </div>

    <div id="errorMsg" class="error-msg"></div>
  </div>

  <script src="js/livekit-loader.js"></script>

  <script>
    // ‚úÖ Detecta autom√°ticamente si est√°s en local o producci√≥n
    const API_URL = 'http://localhost:3000'
    
    const micBtn = document.getElementById('micBtn');
    const statusEl = document.getElementById('status');
    const transcriptEl = document.getElementById('transcript');
    const responseEl = document.getElementById('response');
    const errorMsg = document.getElementById('errorMsg');
    const clearBtn = document.getElementById('clearBtn');
    const loadAvatarBtn = document.getElementById('loadAvatarBtn');
    const testBtn = document.getElementById('testBtn');
    const disconnectAvatarBtn = document.getElementById('disconnectAvatarBtn');
    const avatarVideo = document.getElementById('avatarVideo');
    let audioUnlocked = false;
    const avatarStatusEl = document.getElementById('avatarStatus');

    // ==================== VARIABLES GLOBALES ====================
    let recognition = null;
    let isListening = false;
    let currentAudio = null;
    let avatarSession = null;
    let livekitRoom = null;

    function log(emoji, msg, data=null){ console.log(`${emoji} ${msg}`, data||''); }

    function updateStatus(type, msg){
      statusEl.className = `status ${type}`;
      statusEl.innerHTML = msg;
    }

    function updateAvatarStatus(type, msg){
      avatarStatusEl.className = `status ${type}`;
      avatarStatusEl.innerHTML = msg;
    }

    function showError(msg){
      errorMsg.textContent = `‚ùå ${msg}`;
      errorMsg.style.display = 'block';
      setTimeout(()=>errorMsg.style.display='none', 6000);
    }

    // Inicializar reconocimiento de voz
    function initSpeechRecognition(){
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SpeechRecognition){ showError('Tu navegador no soporta reconocimiento de voz'); return false; }
      recognition = new SpeechRecognition();
      recognition.lang = 'es-ES';
      recognition.interimResults = true;

      recognition.onstart = ()=>{
        isListening = true;
        micBtn.classList.add('recording');
        updateStatus('listening', 'üëÇ Escuchando...');
      };

      recognition.onresult = (e)=>{
        let finalText = '';
        for(let i = e.resultIndex; i < e.results.length; i++){
          const t = e.results[i][0].transcript;
          if(e.results[i].isFinal) finalText += t;
          else transcriptEl.textContent = t;
        }
        if(finalText){
          transcriptEl.textContent = finalText;
          processWithChatbot(finalText);
        }
      };

      recognition.onerror = e=>{
        showError('Error: ' + e.error);
        updateStatus('idle', 'Presiona el micr√≥fono para hablar');
      };
      recognition.onend = ()=>{ micBtn.classList.remove('recording'); isListening = false; };
      return true;
    }

    function startListening(){
      if(!recognition){ showError('Reconocimiento no disponible'); return; }
      if(isListening){ recognition.stop(); return; }
      recognition.start();
    }

    // ==================== CHATBOT + HEYGEN AVATAR ====================
    async function initAvatarSession() {
      if (avatarSession) {
        log('‚ÑπÔ∏è', 'Sesi√≥n de avatar ya existe');
        return avatarSession;
      }

      log('ü§ñ', 'Inicializando sesi√≥n de avatar...');
      updateAvatarStatus('processing', 'ü§ñ Conectando avatar...');

      try {
        const response = await fetch(`${API_URL}/api/heygen/session`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ quality: 'medium' })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `Error ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        avatarSession = data.data;

        log('‚úÖ', 'Sesi√≥n de avatar creada:', avatarSession);

        // Conectar a LiveKit
        await connectToLiveKit(avatarSession.url, avatarSession.access_token);

        updateAvatarStatus('idle', 'ü§ñ Avatar conectado');
        return avatarSession;

      } catch (error) {
        log('‚ùå', 'Error inicializando avatar:', error);
        showError(`Error con avatar: ${error.message}`);
        updateAvatarStatus('idle', 'Avatar desconectado');
        return null;
      }
    }

    async function connectToLiveKit(url, token) {
      log('üîó', 'Conectando a LiveKit...');

      try {
        // Detectar namespace de LiveKit expuesto por el UMD
        const candidates = [
          window.LivekitClient,
          window.livekit,
          window.LiveKit,
          window.Livekit,
        ].filter(Boolean);

        let lk = candidates.find(c => typeof c.connect === 'function' || typeof c.Room !== 'undefined');

        if (!lk) {
          const lkKeys = Object.keys(window).filter(k => k.toLowerCase().includes('livekit') || k.toLowerCase().includes('lk'));
          for (const key of lkKeys) {
            const obj = window[key];
            if (obj && (typeof obj.connect === 'function' || typeof obj.Room !== 'undefined')) {
              lk = obj; break;
            }
          }
        }

        if (!lk) {
          console.log('üîç Debug LiveKit globals:', Object.keys(window).filter(k => k.toLowerCase().includes('livekit') || k.toLowerCase().includes('lk')));
          throw new Error('LiveKit client no disponible. Espera a que se cargue.');
        }

        // Configurar opciones de conexi√≥n
        const connectOptions = { autoSubscribe: true, adaptiveStream: true };

        // Preferir API connect() del UMD, cae a new Room().connect
        if (typeof lk.connect === 'function') {
          livekitRoom = await lk.connect(url, token, connectOptions);
        } else if (typeof lk.Room === 'function') {
          livekitRoom = new lk.Room();
          await livekitRoom.connect(url, token, connectOptions);
        } else {
          throw new Error('No se encontr√≥ m√©todo connect ni clase Room en LiveKit');
        }

        log('‚úÖ', 'Conectado a LiveKit');

        // Manejar pistas de v√≠deo/audio
        const attachVideo = (track) => {
          if (!track) return;
          if (typeof track.attach === 'function') {
            track.attach(avatarVideo);
            avatarVideo.style.display = 'block';
            log('üé•', 'V√≠deo del avatar asignado (attach)');
          } else if (track.mediaStreamTrack) {
            const mediaStream = new MediaStream([track.mediaStreamTrack]);
            avatarVideo.srcObject = mediaStream;
            avatarVideo.style.display = 'block';
            log('üé•', 'V√≠deo del avatar asignado (MediaStream)');
          }
        };

        livekitRoom.on('trackSubscribed', (track, publication, participant) => {
          log('üì°', 'Nueva pista recibida:', track.kind);
          if (track.kind === 'video') {
            attachVideo(track);
          } else if (track.kind === 'audio') {
            // Mute the audio track from HeyGen to only hear ElevenLabs voice
            if (track.mediaStreamTrack) {
              track.mediaStreamTrack.enabled = false;
              log('üîá', 'Audio del avatar silenciado (solo se escucha ElevenLabs)');
            }
          }
        });

        livekitRoom.on('trackUnsubscribed', (track, publication, participant) => {
          log('üì°', 'Pista removida:', track.kind);
          if (track.kind === 'video') {
            avatarVideo.srcObject = null;
            avatarVideo.style.display = 'none';
          }
        });

        // Manejar desconexi√≥n
        livekitRoom.on('disconnected', () => {
          log('üîå', 'Desconectado de LiveKit');
          avatarVideo.srcObject = null;
          avatarVideo.style.display = 'none';
        });

        // Enlazar cualquier pista ya publicada antes de registrar eventos
        try {
          const participants = [];
          if (livekitRoom.localParticipant) {
            participants.push(livekitRoom.localParticipant);
          }
          if (livekitRoom.participants && typeof livekitRoom.participants.values === 'function') {
            participants.push(...Array.from(livekitRoom.participants.values()));
          }
          for (const p of participants) {
            for (const pub of p.trackPublications || []) {
              const t = pub.track;
              if (t && t.kind === 'video') attachVideo(t);
            }
            // Algunos builds exponen publications como Map
            if (p.tracks && p.tracks.forEach) {
              p.tracks.forEach((pub) => {
                const t = pub.track;
                if (t && t.kind === 'video') attachVideo(t);
              });
            }
          }
        } catch (e) {
          log('‚ÑπÔ∏è', 'No se pudieron inspeccionar pistas iniciales:', e);
        }

      } catch (error) {
        log('‚ùå', 'Error conectando a LiveKit:', error);
        throw error;
      }
    }

    async function sendTextToAvatar(text) {
      if (!avatarSession) {
        log('‚ö†Ô∏è', 'No hay sesi√≥n de avatar activa');
        return;
      }

      if (!text || !text.trim()) {
        log('‚ö†Ô∏è', 'Texto vac√≠o, ignorando...');
        return;
      }

      log('üí¨', 'Enviando texto al avatar:', text);

      try {
        const response = await fetch(`${API_URL}/api/heygen/speak`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            sessionId: avatarSession.session_id,
            text: text.trim(),
            source: 'chatbot'
          })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `Error ${response.status}: ${response.statusText}`);
        }

        log('‚úÖ', 'Texto enviado al avatar');

      } catch (error) {
        log('‚ùå', 'Error enviando texto al avatar:', error);
        showError(`Error con avatar: ${error.message}`);
      }
    }

    async function stopAvatarSession() {
      if (!avatarSession) {
        log('‚ÑπÔ∏è', 'No hay sesi√≥n de avatar para detener');
        return;
      }

      log('üõë', 'Deteniendo sesi√≥n de avatar...');

      try {
        await fetch(`${API_URL}/api/heygen/stop`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            sessionId: avatarSession.session_id
          })
        });

        if (livekitRoom) {
          await livekitRoom.disconnect();
          livekitRoom = null;
        }

        avatarVideo.srcObject = null;
        avatarVideo.style.display = 'none';
        avatarSession = null;

        updateAvatarStatus('idle', 'Avatar desconectado');
        log('‚úÖ', 'Sesi√≥n de avatar detenida');

      } catch (error) {
        log('‚ùå', 'Error deteniendo avatar:', error);
      }
    }

    // ==================== CHATBOT + AVATAR INTEGRATION ====================
    async function processWithChatbot(text){
      if(!text.trim()) return;
      const startedAt = Date.now();
      updateStatus('processing', 'ü§ñ Procesando con el chatbot...');
      responseEl.textContent = 'Pensando...';
      if (typeof log === 'function') log('[UI]', '‚ñ∂Ô∏è Inicia flujo chatbot‚ÜíTTS‚Üíavatar', { textPreview: text.slice(0,80) });

      try{
        const res = await fetch(`${API_URL}/api/chatbot`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text })
        });

        if(!res.ok) throw new Error(`Error ${res.status}`);

        const chatbotReply = decodeURIComponent(res.headers.get('X-Chatbot-Response') || '');
        if (typeof log === 'function') log('[UI]', '‚úÖ Respuesta chatbot recibida', { len: chatbotReply.length });
        responseEl.textContent = chatbotReply || 'Respuesta recibida';

        // Initialize avatar session if not already done
        if (!avatarSession) {
          await initAvatarSession();
        }

        // Send chatbot response to avatar
        if (typeof log === 'function') {
          log('[UI]', '‚ÑπÔ∏è Estado previo a enviar al avatar', {
            hasSession: !!avatarSession,
            hasReply: !!chatbotReply,
            sessionId: avatarSession?.session_id
          });
        }
        if (avatarSession && chatbotReply) {
          await sendTextToAvatar(chatbotReply);
          if (typeof log === 'function') log('[UI]', 'üì§ Enviado texto al avatar');
        } else {
          if (typeof log === 'function') {
            if (!avatarSession) log('[UI]', '‚õî No hay sesi√≥n de avatar activa');
            if (!chatbotReply) log('[UI]', '‚õî Respuesta del chatbot vac√≠a');
          }
        }

        const audioBlob = await res.blob();
        const audioUrl = URL.createObjectURL(audioBlob);

        if(currentAudio){ currentAudio.pause(); currentAudio.currentTime=0; }
        currentAudio = new Audio(audioUrl);
        updateStatus('playing', 'üîä Reproduciendo respuesta...');
        currentAudio.onended = ()=>updateStatus('idle', 'Presiona el micr√≥fono para hablar');
        await currentAudio.play();
        if (typeof log === 'function') log('[UI]', 'üîä Reproducci√≥n de audio iniciada');
        if (typeof log === 'function') log('[UI]', '‚è±Ô∏è Flujo completado', { totalMs: Date.now() - startedAt });
      }catch(err){
        showError(err.message);
        updateStatus('idle','Presiona el micr√≥fono para hablar');
      }
    }

    function clearAll(){
      transcriptEl.textContent='Aqu√≠ aparecer√° lo que digas...';
      responseEl.textContent='Esperando tu mensaje...';
      updateStatus('idle','Presiona el micr√≥fono para comenzar');
      if(currentAudio){currentAudio.pause(); currentAudio=null;}
    }

    micBtn.onclick = startListening;
    clearBtn.onclick = clearAll;
    loadAvatarBtn.onclick = initAvatarSession;
    testBtn.onclick = ()=>processWithChatbot('Hola, soy el asistente de voz, ¬øc√≥mo est√°s?');
    disconnectAvatarBtn.onclick = stopAvatarSession;

    // Desbloquear audio/LiveKit tras primer gesto del usuario
    micBtn.addEventListener('click', async () => {
      if (audioUnlocked) return;
      try {
        // Asegura la sesi√≥n de avatar creada tras gesto
        if (!avatarSession && typeof initAvatarSession === 'function') {
          await initAvatarSession();
        }
        // Desbloquear el audio de LiveKit si est√° disponible
        if (livekitRoom && typeof livekitRoom.startAudio === 'function') {
          await livekitRoom.startAudio();
        }
        avatarVideo.muted = false;
        audioUnlocked = true;
        if (typeof log === 'function') log('üîì', 'Audio desbloqueado por gesto del usuario');
      } catch (e) {
        if (typeof log === 'function') log('‚ùå', 'Error desbloqueando audio:', e);
        console.error(e);
      }
    }, { once: true });

    window.onload = ()=>{
      if(initSpeechRecognition()) updateStatus('idle','Presiona el micr√≥fono para hablar üëã');
      // No iniciar sesi√≥n de avatar autom√°ticamente para cumplir autoplay policy
    };
  </script>
</body>
</html>
