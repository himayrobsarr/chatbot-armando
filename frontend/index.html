<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üé§ Chatbot de Voz Inteligente</title>
  <script src="js/livekit-loader.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #0f172a;
      color: #fff;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .container {
      background: #1e293b;
      border-radius: 24px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      padding: 48px;
      max-width: 720px;
      width: 100%;
      border: 1px solid #334155;
    }
    h1 {
      text-align: center;
      margin-bottom: 8px;
      font-size: 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .subtitle {
      text-align: center;
      color: #94a3b8;
      margin-bottom: 40px;
      font-size: 16px;
    }
    .mic-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      margin: 40px 0;
    }
    .mic-button {
      width: 140px; height: 140px;
      border-radius: 50%;
      border: 4px solid #667eea;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 56px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
      display: flex; align-items: center; justify-content: center;
      user-select: none;
    }
    .mic-button:hover { transform: scale(1.05); box-shadow: 0 15px 50px rgba(102, 126, 234, 0.6); }
    .mic-button.recording {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      border-color: #ef4444;
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); box-shadow: 0 10px 40px rgba(239, 68, 68, 0.4); }
      50% { transform: scale(1.08); box-shadow: 0 15px 60px rgba(239, 68, 68, 0.8); }
    }
    .status {
      text-align: center;
      padding: 16px 24px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 18px;
      min-width: 300px;
      transition: all 0.3s ease;
    }
    .status.idle { background: #1e40af20; color: #60a5fa; border: 2px solid #1e40af40; }
    .status.listening { background: #f59e0b20; color: #fbbf24; border: 2px solid #f59e0b40; }
    .status.processing { background: #8b5cf620; color: #a78bfa; border: 2px solid #8b5cf640; }
    .status.playing { background: #10b98120; color: #34d399; border: 2px solid #10b98140; }

    .transcript-box, .response-box {
      background: #0f172a;
      border-radius: 16px;
      padding: 24px;
      margin-top: 32px;
      border: 1px solid #334155;
      min-height: 100px;
    }
    .transcript-box h3, .response-box h3 {
      color: #94a3b8;
      margin-bottom: 12px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }
    .transcript-text, .response-text {
      color: #e2e8f0;
      font-size: 18px;
      line-height: 1.6;
      font-style: italic;
    }
    .response-text {
      font-style: normal;
      color: #a5b4fc;
    }

    .avatar-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      margin-top: 32px;
      padding: 24px;
      background: #0f172a;
      border-radius: 16px;
      border: 1px solid #334155;
    }

    .avatar-container h3 {
      color: #94a3b8;
      margin-bottom: 8px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }

    .controls {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 24px;
    }
    .btn {
      padding: 12px 24px;
      border: 2px solid #334155;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      background: #1e293b;
      color: #e2e8f0;
      font-size: 15px;
    }
    .btn:hover { background: #334155; border-color: #475569; transform: translateY(-2px); }
    .error-msg {
      background: #7f1d1d;
      color: #fca5a5;
      padding: 16px 20px;
      border-radius: 12px;
      margin-top: 20px;
      text-align: center;
      border: 2px solid #991b1b;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ü§ñ Chatbot de Voz</h1>
    <p class="subtitle">Habla y escucha respuestas generadas por IA</p>

    <div class="mic-container">
      <button id="micBtn" class="mic-button" type="button">üé§</button>
      <div id="status" class="status idle">Sistema listo - Presiona el micr√≥fono para comenzar</div>
    </div>

    <div class="transcript-box">
      <h3>üó£Ô∏è Tu voz (Transcripci√≥n)</h3>
      <div id="transcript" class="transcript-text empty">Aqu√≠ aparecer√° lo que digas...</div>
    </div>

    <div class="response-box">
      <h3>üí¨ Respuesta del Chatbot</h3>
      <div id="response" class="response-text">Esperando tu mensaje...</div>
    </div>

    <!-- Estado del Avatar -->
    <div style="background: #0f172a; border-radius: 16px; padding: 24px; margin-top: 32px; border: 1px solid #334155;">
      <h3 style="color: #94a3b8; margin-bottom: 12px; font-size: 14px; text-transform: uppercase; letter-spacing: 1.5px;">üìä Estado del Sistema</h3>
      <div id="status" class="status idle">Sistema listo - Presiona el micr√≥fono para comenzar</div>
    </div>

    <div class="avatar-container">
      <h3>ü§ñ Avatar Interactivo</h3>
      <video id="avatarVideo" autoplay muted playsinline style="width: 100%; max-width: 400px; border-radius: 16px; background: #0f172a;"></video>
      <div id="avatarStatus" class="status idle" style="margin-top: 16px;">
        Avatar desconectado
      </div>

      <!-- Controles del Avatar -->
      <div style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;">
        <button id="startBtn" class="btn">‚ñ∂Ô∏è Iniciar Avatar</button>
        <button id="stopBtn" class="btn" disabled>‚èπÔ∏è Detener Avatar</button>
      </div>

      <!-- Input para texto -->
      <div style="margin-top: 16px;">
        <input type="text" id="textInput" placeholder="Escribe algo para que el avatar diga..." style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #334155; background: #1e293b; color: #e2e8f0; font-size: 16px;" disabled>
        <button id="speakBtn" class="btn" style="margin-top: 8px; width: 100%;" disabled>üí¨ Hacer hablar al Avatar</button>
      </div>
    </div>

    <div class="controls">
      <button id="clearBtn" class="btn">üóëÔ∏è Limpiar</button>
      <button id="testBtn" class="btn">üß™ Test Chatbot</button>
    </div>

    <script>
      // ================================================
      // ü§ñ Chatbot + Speech Integration
      // ================================================

      // Variables globales
      let isListening = false;
      let currentAudio = null;

      // Elementos del DOM
      const micBtn = document.getElementById('micBtn');
      const statusEl = document.getElementById('status');
      const transcriptEl = document.getElementById('transcript');
      const responseEl = document.getElementById('response');
      const clearBtn = document.getElementById('clearBtn');
      const testBtn = document.getElementById('testBtn');

      // API URL
      const API_URL = 'http://localhost:3000';

      // Funci√≥n para actualizar estado
      function updateStatus(type, msg) {
        statusEl.className = `status ${type}`;
        statusEl.innerHTML = msg;
        console.log(`[UI] ${msg}`);
      }

      // Funci√≥n para mostrar errores
      function showError(msg) {
        updateStatus('idle', `‚ùå Error: ${msg}`);
        setTimeout(() => updateStatus('idle', 'Presiona el micr√≥fono para hablar'), 5000);
      }

      // Inicializar Speech Recognition
      function initSpeechRecognition() {
        if (!SpeechManager.isAvailable()) {
          showError('Tu navegador no soporta reconocimiento de voz');
          return false;
        }

        SpeechManager.init();

        SpeechManager.onStart = () => {
          isListening = true;
          micBtn.classList.add('recording');
          updateStatus('listening', 'üëÇ Escuchando...');
        };

        SpeechManager.onResult = (text) => {
          transcriptEl.textContent = text;
          processWithChatbot(text);
        };

        SpeechManager.onError = (error) => {
          showError('Error de reconocimiento: ' + error);
          micBtn.classList.remove('recording');
          isListening = false;
        };

        SpeechManager.onEnd = () => {
          micBtn.classList.remove('recording');
          isListening = false;
        };

        return true;
      }

      // Procesar texto con el chatbot
      async function processWithChatbot(text) {
        if (!text.trim()) return;

        const startedAt = Date.now();
        updateStatus('processing', 'ü§ñ Procesando con el chatbot...');
        responseEl.textContent = 'Pensando...';

        try {
          const res = await fetch(`${API_URL}/api/chatbot`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text })
          });

          if (!res.ok) throw new Error(`Error ${res.status}`);

          const chatbotReply = decodeURIComponent(res.headers.get('X-Chatbot-Response') || '');
          responseEl.textContent = chatbotReply || 'Respuesta recibida';

          // Initialize avatar session if not already done
          if (window.avatarManager && !window.avatarManager.sessionInfo) {
            console.log('[UI] Inicializando sesi√≥n de avatar...');
            await window.avatarManager.startSession();
          }

          // Send chatbot response to avatar
          if (window.avatarManager && window.avatarManager.sessionInfo && chatbotReply) {
            console.log('[UI] Enviando respuesta al avatar...');
            await window.avatarManager.sendTextToAvatar(chatbotReply);
          }

          const audioBlob = await res.blob();
          const audioUrl = URL.createObjectURL(audioBlob);

          if (currentAudio) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
          }
          currentAudio = new Audio(audioUrl);
          updateStatus('playing', 'üîä Reproduciendo respuesta...');
          currentAudio.onended = () => updateStatus('idle', 'Presiona el micr√≥fono para hablar');
          await currentAudio.play();

          console.log(`[UI] Flujo completado en ${Date.now() - startedAt}ms`);

        } catch (err) {
          showError(err.message);
          updateStatus('idle', 'Presiona el micr√≥fono para hablar');
        }
      }

      // Funci√≥n para limpiar
      function clearAll() {
        transcriptEl.textContent = 'Aqu√≠ aparecer√° lo que digas...';
        responseEl.textContent = 'Esperando tu mensaje...';
        updateStatus('idle', 'Presiona el micr√≥fono para hablar');
        if (currentAudio) {
          currentAudio.pause();
          currentAudio = null;
        }
      }

      // Event listeners
      micBtn.onclick = () => {
        if (!SpeechManager.recognition) {
          if (!initSpeechRecognition()) return;
        }

        if (isListening) {
          SpeechManager.stop();
        } else {
          SpeechManager.start();
        }
      };

      clearBtn.onclick = clearAll;
      testBtn.onclick = () => processWithChatbot('Hola, soy el asistente de voz, ¬øc√≥mo est√°s?');

      // Inicializaci√≥n
      window.onload = () => {
        if (initSpeechRecognition()) {
          updateStatus('idle', 'Presiona el micr√≥fono para hablar üëã');
        }
      };
    </script>

    <div id="errorMsg" class="error-msg"></div>
  </div>

  <script src="js/livekit-loader.js"></script>
  <script src="js/audio.js"></script>
  <script src="js/speech.js"></script>
  <script src="js/simple-avatar.js"></script>
</body>
</html>
