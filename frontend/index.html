<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice Repeater - Eleven Labs</title>
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #0f172a;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      color: #fff;
    }

    .container {
      background: #1e293b;
      border-radius: 24px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      padding: 48px;
      max-width: 700px;
      width: 100%;
      border: 1px solid #334155;
    }

    h1 {
      text-align: center;
      margin-bottom: 8px;
      font-size: 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      text-align: center;
      color: #94a3b8;
      margin-bottom: 40px;
      font-size: 16px;
    }

    .mic-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      margin: 40px 0;
    }

    .mic-button {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      border: 4px solid #667eea;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 56px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .mic-button:hover {
      transform: scale(1.05);
      box-shadow: 0 15px 50px rgba(102, 126, 234, 0.6);
    }

    .mic-button:active {
      transform: scale(0.98);
    }

    .mic-button.recording {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      border-color: #ef4444;
      animation: pulse 1.5s ease-in-out infinite;
    }

    .mic-button.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    @keyframes pulse {
      0%, 100% { 
        transform: scale(1); 
        box-shadow: 0 10px 40px rgba(239, 68, 68, 0.4);
      }
      50% { 
        transform: scale(1.08); 
        box-shadow: 0 15px 60px rgba(239, 68, 68, 0.8);
      }
    }

    .status {
      text-align: center;
      padding: 16px 24px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 18px;
      min-width: 300px;
      transition: all 0.3s ease;
    }

    .status.idle {
      background: #1e40af20;
      color: #60a5fa;
      border: 2px solid #1e40af40;
    }

    .status.listening {
      background: #f59e0b20;
      color: #fbbf24;
      border: 2px solid #f59e0b40;
    }

    .status.processing {
      background: #8b5cf620;
      color: #a78bfa;
      border: 2px solid #8b5cf640;
    }

    .status.playing {
      background: #10b98120;
      color: #34d399;
      border: 2px solid #10b98140;
    }

    .transcript-box {
      background: #0f172a;
      border-radius: 16px;
      padding: 24px;
      margin-top: 32px;
      min-height: 120px;
      border: 1px solid #334155;
    }

    .transcript-box h3 {
      color: #94a3b8;
      margin-bottom: 16px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }

    .transcript-text {
      color: #e2e8f0;
      font-size: 18px;
      line-height: 1.7;
      font-style: italic;
    }

    .transcript-text.empty {
      color: #475569;
    }

    .controls {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 24px;
    }

    .btn {
      padding: 12px 24px;
      border: 2px solid #334155;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      background: #1e293b;
      color: #e2e8f0;
      font-size: 15px;
    }

    .btn:hover {
      background: #334155;
      border-color: #475569;
      transform: translateY(-2px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .error-msg {
      background: #7f1d1d;
      color: #fca5a5;
      padding: 16px 20px;
      border-radius: 12px;
      margin-top: 20px;
      text-align: center;
      border: 2px solid #991b1b;
      display: none;
    }

    .info-box {
      background: #1e40af20;
      border: 2px solid #1e40af40;
      color: #93c5fd;
      padding: 12px 16px;
      border-radius: 10px;
      margin-top: 20px;
      font-size: 14px;
      text-align: center;
    }

    .wave {
      display: inline-block;
      animation: wave 2s ease-in-out infinite;
    }

    @keyframes wave {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(20deg); }
      75% { transform: rotate(-20deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé§ Voice Repeater</h1>
    <p class="subtitle">Habla y escucha tu voz con Eleven Labs</p>

    <div class="mic-container">
      <button id="micBtn" class="mic-button" type="button">
        üé§
      </button>

      <div id="status" class="status idle">
        Presiona el micr√≥fono para comenzar
      </div>
    </div>

    <div class="transcript-box">
      <h3>üìù Transcripci√≥n</h3>
      <div id="transcript" class="transcript-text empty">
        Aqu√≠ aparecer√° lo que digas...
      </div>
    </div>

    <div class="controls">
      <button id="clearBtn" class="btn">üóëÔ∏è Limpiar</button>
      <button id="testBtn" class="btn">üß™ Test Audio</button>
    </div>

    <div id="errorMsg" class="error-msg"></div>
    
    <div id="infoBox" class="info-box" style="display: none;">
      ‚ÑπÔ∏è Permite el acceso al micr√≥fono cuando el navegador lo solicite
    </div>
  </div>

  <script>
    console.log('üöÄ Cargando aplicaci√≥n...');

    // ==================== CONFIGURACI√ìN ====================
    const API_URL = 'http://localhost:3000';
    
    // ==================== ELEMENTOS DOM ====================
    const micBtn = document.getElementById('micBtn');
    const statusEl = document.getElementById('status');
    const transcriptEl = document.getElementById('transcript');
    const clearBtn = document.getElementById('clearBtn');
    const testBtn = document.getElementById('testBtn');
    const errorMsg = document.getElementById('errorMsg');
    const infoBox = document.getElementById('infoBox');

    // ==================== VARIABLES GLOBALES ====================
    let recognition = null;
    let isListening = false;
    let currentAudio = null;

    // ==================== LOG HELPER ====================
    function log(emoji, message, data = null) {
      const timestamp = new Date().toLocaleTimeString();
      console.log(`${emoji} [${timestamp}] ${message}`, data || '');
    }

    // ==================== INICIALIZAR RECONOCIMIENTO ====================
    function initSpeechRecognition() {
      log('üîß', 'Inicializando reconocimiento de voz...');

      // Verificar soporte
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      
      if (!SpeechRecognition) {
        showError('Tu navegador no soporta reconocimiento de voz. Usa Chrome, Edge o Safari.');
        micBtn.classList.add('disabled');
        return false;
      }

      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = true;
      recognition.lang = 'es-ES';
      recognition.maxAlternatives = 1;

      // ==================== EVENTOS ====================
      recognition.onstart = () => {
        log('üé§', 'Reconocimiento iniciado');
        isListening = true;
        micBtn.classList.add('recording');
        updateStatus('listening', 'üëÇ Escuchando... Habla ahora');
        hideError();
      };

      recognition.onresult = (event) => {
        let interimTranscript = '';
        let finalTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          
          if (event.results[i].isFinal) {
            finalTranscript += transcript;
          } else {
            interimTranscript += transcript;
          }
        }

        // Mostrar transcripci√≥n en tiempo real
        if (interimTranscript) {
          transcriptEl.textContent = interimTranscript;
          transcriptEl.classList.remove('empty');
        }

        // Cuando hay texto final, procesar
        if (finalTranscript) {
          log('üìù', 'Transcripci√≥n final:', finalTranscript);
          transcriptEl.textContent = finalTranscript;
          transcriptEl.classList.remove('empty');
          processWithElevenLabs(finalTranscript);
        }
      };

      recognition.onerror = (event) => {
        log('‚ùå', 'Error en reconocimiento:', event.error);
        
        stopListening();

        switch(event.error) {
          case 'no-speech':
            showError('No detect√© voz. Intenta de nuevo y habla m√°s fuerte.');
            break;
          case 'audio-capture':
            showError('No se pudo acceder al micr√≥fono. Verifica los permisos.');
            infoBox.style.display = 'block';
            break;
          case 'not-allowed':
            showError('Permiso de micr√≥fono denegado. Act√≠valo en la configuraci√≥n del navegador.');
            infoBox.style.display = 'block';
            break;
          case 'aborted':
            updateStatus('idle', 'Grabaci√≥n cancelada');
            break;
          default:
            showError(`Error: ${event.error}`);
        }
      };

      recognition.onend = () => {
        log('üõë', 'Reconocimiento finalizado');
        stopListening();
      };

      log('‚úÖ', 'Reconocimiento de voz listo');
      return true;
    }

    // ==================== CONTROL DE GRABACI√ìN ====================
    function startListening() {
      if (!recognition) {
        showError('El reconocimiento de voz no est√° disponible');
        return;
      }

      if (isListening) {
        log('‚èπÔ∏è', 'Deteniendo grabaci√≥n...');
        recognition.stop();
        return;
      }

      log('‚ñ∂Ô∏è', 'Iniciando grabaci√≥n...');
      
      try {
        recognition.start();
      } catch (error) {
        log('‚ùå', 'Error al iniciar:', error);
        showError('Error al iniciar el micr√≥fono. Recarga la p√°gina.');
      }
    }

    function stopListening() {
      isListening = false;
      micBtn.classList.remove('recording');
      
      if (!currentAudio) {
        updateStatus('idle', 'Presiona el micr√≥fono para hablar');
      }
    }

    // ==================== ELEVEN LABS ====================
    async function processWithElevenLabs(text) {
      if (!text || !text.trim()) {
        log('‚ö†Ô∏è', 'Texto vac√≠o, ignorando...');
        return;
      }

      log('üì§', 'Enviando a Eleven Labs:', text);
      updateStatus('processing', '‚öôÔ∏è Generando audio...');

      try {
        const response = await fetch(`${API_URL}/api/test/elevenlabs`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ text: text.trim() })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `Error ${response.status}: ${response.statusText}`);
        }

        log('‚úÖ', 'Audio recibido de Eleven Labs');

        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        
        // Detener audio previo
        if (currentAudio) {
          currentAudio.pause();
          currentAudio.currentTime = 0;
        }

        currentAudio = new Audio(audioUrl);

        updateStatus('playing', 'üîä Reproduciendo audio...');

        currentAudio.onended = () => {
          log('‚úÖ', 'Reproducci√≥n finalizada');
          updateStatus('idle', 'Presiona el micr√≥fono para hablar');
          URL.revokeObjectURL(audioUrl);
          currentAudio = null;
        };

        currentAudio.onerror = (e) => {
          log('‚ùå', 'Error reproduciendo audio:', e);
          showError('Error al reproducir el audio');
          updateStatus('idle', 'Presiona el micr√≥fono para hablar');
          currentAudio = null;
        };

        await currentAudio.play();
        log('üîä', 'Reproduciendo...');

      } catch (error) {
        log('‚ùå', 'Error con Eleven Labs:', error);
        showError(`Error: ${error.message}`);
        updateStatus('idle', 'Presiona el micr√≥fono para hablar');
      }
    }

    // ==================== TEST AUDIO ====================
    async function testAudio() {
      log('üß™', 'Probando conexi√≥n con Eleven Labs...');
      await processWithElevenLabs('Hola, esta es una prueba del sistema de audio');
    }

    // ==================== UI HELPERS ====================
    function updateStatus(type, message) {
      statusEl.className = `status ${type}`;
      statusEl.innerHTML = message;
      log('üìä', `Estado: ${type} - ${message}`);
    }

    function showError(message) {
      errorMsg.textContent = `‚ùå ${message}`;
      errorMsg.style.display = 'block';
      log('‚ùå', message);
      
      setTimeout(() => {
        hideError();
      }, 7000);
    }

    function hideError() {
      errorMsg.style.display = 'none';
      infoBox.style.display = 'none';
    }

    function clearAll() {
      log('üóëÔ∏è', 'Limpiando...');
      transcriptEl.textContent = 'Aqu√≠ aparecer√° lo que digas...';
      transcriptEl.classList.add('empty');
      hideError();
      
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
      }
      
      if (isListening && recognition) {
        recognition.stop();
      }
      
      updateStatus('idle', 'Presiona el micr√≥fono para hablar');
    }

    // ==================== EVENT LISTENERS ====================
    micBtn.addEventListener('click', (e) => {
      e.preventDefault();
      log('üëÜ', 'Click en bot√≥n de micr√≥fono');
      startListening();
    });

    clearBtn.addEventListener('click', (e) => {
      e.preventDefault();
      clearAll();
    });

    testBtn.addEventListener('click', (e) => {
      e.preventDefault();
      testAudio();
    });

    // Prevenir comportamientos por defecto
    micBtn.addEventListener('touchstart', (e) => {
      e.preventDefault();
      startListening();
    });

    // ==================== INICIALIZACI√ìN ====================
    window.addEventListener('DOMContentLoaded', () => {
      log('üöÄ', 'Aplicaci√≥n iniciada');
      
      if (initSpeechRecognition()) {
        log('‚úÖ', 'Sistema listo para usar');
        updateStatus('idle', 'Presiona el micr√≥fono para comenzar <span class="wave">üëã</span>');
      } else {
        log('‚ùå', 'Error al inicializar');
      }
    });

    // Log de versi√≥n
    log('‚ÑπÔ∏è', 'Voice Repeater v2.0');
    log('‚ÑπÔ∏è', `API URL: ${API_URL}`);
  </script>
</body>
</html>