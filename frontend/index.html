<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asistente Virtual - Palmas del C√©sar</title>
  <script src="js/livekit-loader.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e8eef3 100%);
      color: #2c3e50;
      min-height: 100vh;
      padding: 20px;
    }
    
    /* Header con branding */
    .header {
      text-align: center;
      padding: 32px 0 48px 0;
      max-width: 900px;
      margin: 0 auto;
    }
    
    .company-name {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: #1a4d8f;
      margin-bottom: 12px;
      opacity: 0.8;
    }
    
    .main-title {
      font-size: 32px;
      font-weight: 600;
      color: #1a4d8f;
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }
    
    .subtitle {
      font-size: 16px;
      color: #5a6c7d;
      font-weight: 400;
    }

    /* Layout principal */
    .main-container {
      max-width: 900px;
      margin: 0 auto;
      display: grid;
      gap: 24px;
    }

    /* Contenedor del avatar - PROTAGONISTA */
    .avatar-section {
      background: #ffffff;
      border-radius: 12px;
      padding: 48px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      text-align: center;
      border: 1px solid #e1e8ed;
    }

    #avatarVideo {
      width: 100%;
      max-width: 500px;
      border-radius: 12px;
      background: #f5f7fa;
      border: 2px solid #e1e8ed;
      margin: 0 auto;
      display: block;
    }

    .avatar-controls {
      margin-top: 32px;
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    /* Secci√≥n de interacci√≥n */
    .interaction-section {
      background: #ffffff;
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
      border: 1px solid #e1e8ed;
    }

    .mic-row {
      display: flex;
      align-items: center;
      gap: 24px;
      margin-bottom: 32px;
    }

    .mic-button {
      width: 80px;
      height: 80px;
      min-width: 80px;
      border-radius: 50%;
      border: 3px solid #1a4d8f;
      background: #1a4d8f;
      color: white;
      font-size: 36px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(26, 77, 143, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
    }

    .mic-button:hover { 
      background: #164073;
      border-color: #164073;
      transform: scale(1.05);
    }

    .mic-button.recording {
      background: #d32f2f;
      border-color: #d32f2f;
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 4px 12px rgba(211, 47, 47, 0.3); }
      50% { box-shadow: 0 4px 20px rgba(211, 47, 47, 0.5); }
    }

    .status-info {
      flex: 1;
    }

    .status {
      padding: 12px 20px;
      border-radius: 6px;
      font-weight: 500;
      font-size: 15px;
      transition: all 0.2s ease;
      border: 2px solid;
      display: inline-block;
    }

    .status.idle { background: #e8f4f8; color: #1a4d8f; border-color: #b8d4e3; }
    .status.listening { background: #fff3e0; color: #e65100; border-color: #ffcc80; }
    .status.processing { background: #f3e5f5; color: #6a1b9a; border-color: #ce93d8; }
    .status.playing { background: #e8f5e9; color: #2e7d32; border-color: #a5d6a7; }

    .content-box {
      background: #fafbfc;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid #e1e8ed;
      min-height: 80px;
    }

    .content-box h3 {
      color: #5a6c7d;
      margin-bottom: 10px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }

    .content-text {
      color: #2c3e50;
      font-size: 15px;
      line-height: 1.6;
    }

    .content-text.empty {
      color: #95a5a6;
      font-style: italic;
    }

    /* Controles */
    .btn {
      padding: 12px 24px;
      border: 1px solid #d1d9e0;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
      background: #ffffff;
      color: #2c3e50;
      font-size: 14px;
      font-family: inherit;
    }

    .btn:hover:not(:disabled) { 
      background: #f5f7fa; 
      border-color: #1a4d8f;
      color: #1a4d8f;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: #1a4d8f;
      color: white;
      border-color: #1a4d8f;
    }

    .btn-primary:hover:not(:disabled) {
      background: #164073;
      border-color: #164073;
      color: white;
    }

    #textInput {
      width: 100%;
      padding: 12px 16px;
      border-radius: 6px;
      border: 1px solid #d1d9e0;
      background: #ffffff;
      color: #2c3e50;
      font-size: 15px;
      font-family: inherit;
      margin-top: 16px;
    }

    #textInput:focus {
      outline: none;
      border-color: #1a4d8f;
      box-shadow: 0 0 0 3px rgba(26, 77, 143, 0.1);
    }

    .secondary-controls {
      margin-top: 24px;
      display: flex;
      gap: 12px;
      justify-content: center;
      padding-top: 24px;
      border-top: 1px solid #e1e8ed;
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: 32px 0;
      color: #5a6c7d;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="company-name">Palmas del C√©sar</div>
    <h1 class="main-title">Asistente Virtual Inteligente</h1>
    <p class="subtitle">Interacci√≥n por voz impulsada por inteligencia artificial</p>
  </div>

  <!-- Contenido Principal -->
  <div class="main-container">
    
    <!-- Avatar Section - PROTAGONISTA -->
    <div class="avatar-section">
      <video id="avatarVideo" autoplay muted playsinline></video>
      
      <div id="avatarStatus" class="status idle" style="margin-top: 24px;">
        Avatar desconectado
      </div>

      <div class="avatar-controls">
        <button id="startBtn" class="btn btn-primary">‚ñ∂Ô∏è Iniciar Avatar</button>
        <button id="stopBtn" class="btn" disabled>‚èπÔ∏è Detener</button>
      </div>

      <input 
        type="text" 
        id="textInput" 
        placeholder="Escriba un mensaje para el avatar..." 
        disabled
      >
      <button id="speakBtn" class="btn" style="margin-top: 12px; width: 100%;" disabled>
        üí¨ Enviar al Avatar
      </button>
    </div>

    <!-- Secci√≥n de Interacci√≥n -->
    <div class="interaction-section">
      <div class="mic-row">
        <button id="micBtn" class="mic-button" type="button">üé§</button>
        <div class="status-info">
          <div id="status" class="status idle">Presione el micr√≥fono para hablar</div>
        </div>
      </div>

      <div class="content-box">
        <h3>Su mensaje</h3>
        <div id="transcript" class="content-text empty">Presione el micr√≥fono y comience a hablar...</div>
      </div>

      <div class="content-box">
        <h3>Respuesta</h3>
        <div id="response" class="content-text empty">Esperando instrucciones...</div>
      </div>

      <div class="secondary-controls">
        <button id="clearBtn" class="btn">üóëÔ∏è Limpiar</button>
        <button id="testBtn" class="btn">üß™ Probar Sistema</button>
      </div>
    </div>

  </div>

  <!-- Footer -->
  <div class="footer">
    ¬© 2025 Palmas del C√©sar - Todos los derechos reservados
  </div>

  <script>
    // ================================================
    // Sistema de Asistente Virtual
    // ================================================

    let isListening = false;
    let currentAudio = null;

    const micBtn = document.getElementById('micBtn');
    const statusEl = document.getElementById('status');
    const transcriptEl = document.getElementById('transcript');
    const responseEl = document.getElementById('response');
    const clearBtn = document.getElementById('clearBtn');
    const testBtn = document.getElementById('testBtn');

    const API_URL = 'http://localhost:3000';

    function updateStatus(type, msg) {
      statusEl.className = `status ${type}`;
      statusEl.textContent = msg;
      console.log(`[UI] ${msg}`);
    }

    function showError(msg) {
      updateStatus('idle', `‚ùå Error: ${msg}`);
      setTimeout(() => updateStatus('idle', 'Presione el micr√≥fono para hablar'), 5000);
    }

    function initSpeechRecognition() {
      if (!SpeechManager.isAvailable()) {
        showError('Su navegador no soporta reconocimiento de voz');
        return false;
      }

      SpeechManager.init();

      SpeechManager.onStart = () => {
        isListening = true;
        micBtn.classList.add('recording');
        updateStatus('listening', 'üéôÔ∏è Escuchando...');
      };

      SpeechManager.onResult = (text) => {
        transcriptEl.textContent = text;
        transcriptEl.classList.remove('empty');
        processWithChatbot(text);
      };

      SpeechManager.onError = (error) => {
        showError('Error de reconocimiento: ' + error);
        micBtn.classList.remove('recording');
        isListening = false;
      };

      SpeechManager.onEnd = () => {
        micBtn.classList.remove('recording');
        isListening = false;
      };

      return true;
    }

    async function processWithChatbot(text) {
      if (!text.trim()) return;

      const startedAt = Date.now();
      updateStatus('processing', '‚öôÔ∏è Procesando...');
      responseEl.textContent = 'Procesando su solicitud...';
      responseEl.classList.remove('empty');

      try {
        const res = await fetch(`${API_URL}/api/chatbot`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });

        if (!res.ok) throw new Error(`Error ${res.status}`);

        const chatbotReply = decodeURIComponent(res.headers.get('X-Chatbot-Response') || '');
        responseEl.textContent = chatbotReply || 'Respuesta recibida';

        if (window.avatarManager && !window.avatarManager.sessionInfo) {
          console.log('[UI] Inicializando sesi√≥n de avatar...');
          await window.avatarManager.startSession();
        }

        if (window.avatarManager && window.avatarManager.sessionInfo && chatbotReply) {
          console.log('[UI] Enviando respuesta al avatar...');
          await window.avatarManager.sendTextToAvatar(chatbotReply);
        }

        const audioBlob = await res.blob();
        const audioUrl = URL.createObjectURL(audioBlob);

        if (currentAudio) {
          currentAudio.pause();
          currentAudio.currentTime = 0;
        }
        currentAudio = new Audio(audioUrl);
        updateStatus('playing', 'üîä Reproduciendo...');
        currentAudio.onended = () => updateStatus('idle', 'Presione el micr√≥fono para hablar');
        await currentAudio.play();

        console.log(`[UI] Completado en ${Date.now() - startedAt}ms`);

      } catch (err) {
        showError(err.message);
        updateStatus('idle', 'Presione el micr√≥fono para hablar');
      }
    }

    function clearAll() {
      transcriptEl.textContent = 'Presione el micr√≥fono y comience a hablar...';
      transcriptEl.classList.add('empty');
      responseEl.textContent = 'Esperando instrucciones...';
      responseEl.classList.add('empty');
      updateStatus('idle', 'Presione el micr√≥fono para hablar');
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
      }
    }

    micBtn.onclick = () => {
      if (!SpeechManager.recognition) {
        if (!initSpeechRecognition()) return;
      }

      if (isListening) {
        SpeechManager.stop();
      } else {
        SpeechManager.start();
      }
    };

    clearBtn.onclick = clearAll;
    testBtn.onclick = () => processWithChatbot('Hola, soy el asistente virtual de Palmas del C√©sar');

    window.onload = () => {
      if (initSpeechRecognition()) {
        updateStatus('idle', 'Sistema listo');
      }
    };
  </script>

  <script src="js/livekit-loader.js"></script>
  <script src="js/audio.js"></script>
  <script src="js/speech.js"></script>
  <script src="js/simple-avatar.js"></script>
</body>
</html>